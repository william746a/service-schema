{
  "openapi": "3.0.3",
  "info": {
    "title": "User Service Application Logic (V1)",
    "version": "1.0.0",
    "description": "Specification for a CRUD application managing Users, including basic business logic and persistence."
  },
  "paths": {
    "/users": {
      "post": {
        "summary": "Create a new user",
        "description": "API endpoint to create a new user. The business logic is defined in 'x-services'.",
        "operationId": "apiCreateUser",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/UserCreateDTO"
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "User created successfully",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/UserResponseDTO"
                }
              }
            }
          },
          "400": { "description": "Invalid input" },
          "409": { "description": "User with this email already exists" }
        },
        "x-service-operation": "UserService.createUser"
      }
    }
  },
  "components": {
    "schemas": {
      "UserCreateDTO": {
        "type": "object",
        "description": "Data Transfer Object for creating a new user.",
        "properties": {
          "email": { "type": "string", "format": "email" },
          "password": { "type": "string", "minLength": 8 },
          "displayName": { "type": "string", "maxLength": 50 }
        },
        "required": ["email", "password", "displayName"]
      },
      "UserResponseDTO": {
        "type": "object",
        "description": "Data Transfer Object for returning user data.",
        "properties": {
          "id": { "type": "string", "format": "uuid" },
          "email": { "type": "string", "format": "email" },
          "displayName": { "type": "string" },
          "createdAt": { "type": "string", "format": "date-time" }
        }
      },
      "UserEntity": {
        "type": "object",
        "description": "The persistence model for a User.",
        "x-persistence": {
          "isEntity": true,
          "tableName": "users"
        },
        "properties": {
          "id": {
            "type": "string",
            "format": "uuid",
            "x-persistence": {
              "isPrimaryKey": true,
              "columnName": "user_id",
              "dataType": "uuid"
            }
          },
          "email": {
            "type": "string",
            "x-persistence": {
              "columnName": "user_email",
              "dataType": "varchar(255)",
              "isUnique": true,
              "isNullable": false
            }
          },
          "passwordHash": {
            "type": "string",
            "x-persistence": {
              "columnName": "password_hash",
              "dataType": "varchar(255)",
              "isNullable": false
            }
          },
          "displayName": {
            "type": "string",
            "x-persistence": {
              "columnName": "display_name",
              "dataType": "varchar(50)"
            }
          },
          "createdAt": {
            "type": "string",
            "format": "date-time",
            "x-persistence": {
              "columnName": "created_at",
              "dataType": "timestamp_with_timezone"
            }
          }
        }
      }
    }
  },
  "x-services": {
    "UserService": {
      "description": "Manages all business logic related to users.",
      "operations": {
        "createUser": {
          "description": "Validates, persists, and returns a new user.",
          "parameters": [
            {
              "name": "userDTO",
              "in": "body",
              "schema": {
                "$ref": "#/components/schemas/UserCreateDTO"
              }
            }
          ],
          "returnType": {
            "$ref": "#/components/schemas/UserResponseDTO"
          },
          "x-business-logic": {
            "description": "Logic flow for creating a new user.",
            "steps": [
              {
                "type": "validation",
                "description": "Validate the input DTO.",
                "target": "userDTO",
                "rules": [
                  { "field": "email", "check": "isEmail" },
                  { "field": "password", "check": "minLength:8" },
                  { "field": "displayName", "check": "isNotBlank" }
                ]
              },
              {
                "type": "decision",
                "description": "Check if user with this email already exists.",
                "condition": {
                  "type": "persistence-check",
                  "repository": "UserRepository",
                  "method": "existsByEmail",
                  "parameters": ["userDTO.email"]
                },
                "ifTrue": [
                  {
                    "type": "throw",
                    "exception": "ConflictException",
                    "message": "A user with this email already exists."
                  }
                ]
              },
              {
                "type": "data-transformation",
                "description": "Hash the user's password.",
                "variable": "hashedPassword",
                "method": "passwordEncoder.hash",
                "parameters": ["userDTO.password"]
              },
              {
                "type": "mapping",
                "description": "Map DTO to UserEntity for persistence.",
                "variable": "newUserEntity",
                "source": "userDTO",
                "targetSchema": { "$ref": "#/components/schemas/UserEntity" },
                "fieldMappings": {
                  "passwordHash": "hashedPassword",
                  "createdAt": "now()"
                }
              },
              {
                "type": "persistence-call",
                "description": "Save the new entity to the database.",
                "variable": "savedUser",
                "repository": "UserRepository",
                "method": "save",
                "parameters": ["newUserEntity"]
              },
              {
                "type": "mapping",
                "description": "Map the saved entity back to a response DTO.",
                "variable": "responseDTO",
                "source": "savedUser",
                "targetSchema": { "$ref": "#/components/schemas/UserResponseDTO" }
              },
              {
                "type": "return",
                "description": "Return the new DTO.",
                "value": "responseDTO"
              }
            ]
          }
        }
      }
    }
  }
}
